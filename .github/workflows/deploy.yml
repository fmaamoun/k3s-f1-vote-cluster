name: Production Deployment

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'terraform/**'
      - 'ansible/**'
      - '**.md'
      - '.github/**'
      - '.gitattributes'
      - '.gitignore'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/f1-vote-app

jobs:
  # JOB 1: THE BRAIN
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.decision.outputs.build }}
      should_deploy: ${{ steps.decision.outputs.deploy }}
    steps:
    - uses: actions/checkout@v3

    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          app:
            - 'app/**'        # <--- Capture ALL: src, Dockerfile, package.json...
          k8s:
            - 'kubernetes/**'

    - name: Decide Logic
      id: decision
      run: |
        BUILD="false"
        DEPLOY="false"

        # Rule 1: We only build if the 'app' folder (which contains the Dockerfile) has changed
        if [[ "${{ steps.filter.outputs.app }}" == "true" ]]; then
          BUILD="true"
        fi

        # Rule 2: We deploy if App changes OR K8s changes OR Manual
        if [[ "${{ steps.filter.outputs.app }}" == "true" ]] || \
           [[ "${{ steps.filter.outputs.k8s }}" == "true" ]] || \
           [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          DEPLOY="true"
        fi

        echo "build=$BUILD" >> $GITHUB_OUTPUT
        echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT

  # JOB 2: THE BUILDER (GHCR)
  build-and-push:
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v3

    - name: Lowercase Image Name
      run: |
        echo "IMAGE_NAME=${IMAGE_NAME,,}" >> $GITHUB_ENV

    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        # FIXED CONTEXT: Point to the app/ folder where the Dockerfile is
        context: ./app
        push: true
        tags: ${{ env.IMAGE_NAME }}:latest,${{ env.IMAGE_NAME }}:${{ github.sha }}

  # JOB 3: THE DEPLOYER
  deploy:
    needs: [check-changes, build-and-push]
    if: always() && needs.check-changes.outputs.should_deploy == 'true' && (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ vars.APP_URL }}

    steps:
    - uses: actions/checkout@v3

    - name: Lowercase Image Name
      run: |
        echo "IMAGE_NAME=${IMAGE_NAME,,}" >> $GITHUB_ENV

    - name: Copy Kubernetes files via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.MASTER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        proxy_host: ${{ secrets.BASTION_HOST }}
        proxy_username: ubuntu
        proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "kubernetes/*"
        target: "/home/ubuntu/k8s-deploy"

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        proxy_host: ${{ secrets.BASTION_HOST }}
        proxy_username: ubuntu
        proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
        host: ${{ secrets.MASTER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          
          kubectl apply -f /home/ubuntu/k8s-deploy/kubernetes/
          
          if [ "${{ needs.check-changes.outputs.should_build }}" == "true" ]; then
             echo "Updating Image to GHCR version..."
             kubectl set image deployment/f1-app f1-app=${{ env.IMAGE_NAME }}:${{ github.sha }} -n f1-vote
             kubectl rollout status deployment/f1-app -n f1-vote
          else
             echo "No Build. Skipping image update."
          fi
          
          rm -rf /home/ubuntu/k8s-deploy