name: Production Deployment

on:
  push:
    branches: [ "main" ]
    paths-ignore:
      - 'terraform/**'
      - 'ansible/**'
      - '**.md'
      - '.github/**'
      - '.gitattributes'
      - '.gitignore'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  # Nom de l'image (sera mis en minuscules par le script)
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/f1-vote-app

jobs:
  # JOB 1 : LE CERVEAU üß†
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.decision.outputs.build }}
      should_deploy: ${{ steps.decision.outputs.deploy }}
    steps:
    - uses: actions/checkout@v3

    # Analyse des changements
    - uses: dorny/paths-filter@v2
      id: filter
      with:
        filters: |
          app:
            - 'app/**'        # <--- Capture TOUT : src, Dockerfile, package.json...
          k8s:
            - 'kubernetes/**'

    - name: Decide Logic
      id: decision
      run: |
        BUILD="false"
        DEPLOY="false"

        # R√®gle 1 : On ne build que si le dossier 'app' (qui contient le Dockerfile) a boug√©
        if [[ "${{ steps.filter.outputs.app }}" == "true" ]]; then
          BUILD="true"
        fi

        # R√®gle 2 : On d√©ploie si App change OU K8s change OU Manuel
        if [[ "${{ steps.filter.outputs.app }}" == "true" ]] || \
           [[ "${{ steps.filter.outputs.k8s }}" == "true" ]] || \
           [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          DEPLOY="true"
        fi

        echo "build=$BUILD" >> $GITHUB_OUTPUT
        echo "deploy=$DEPLOY" >> $GITHUB_OUTPUT

  # JOB 2 : LE BUILDER üèóÔ∏è (GHCR)
  build-and-push:
    needs: check-changes
    if: needs.check-changes.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v3

    # Mettre le nom de l'image en minuscules
    - name: Lowercase Image Name
      run: |
        echo "IMAGE_NAME=${IMAGE_NAME,,}" >> $GITHUB_ENV

    # Login GHCR (Plus besoin de secrets DockerHub)
    - name: Log in to the Container registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        # CONTEXTE CORRIG√â : On pointe vers le dossier app/ o√π est le Dockerfile
        context: ./app
        push: true
        tags: ${{ env.IMAGE_NAME }}:latest,${{ env.IMAGE_NAME }}:${{ github.sha }}

  # JOB 3 : LE D√âPLOYEUR üöÄ
  deploy:
    needs: [check-changes, build-and-push]
    if: always() && needs.check-changes.outputs.should_deploy == 'true' && (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')
    runs-on: ubuntu-latest
    environment:
      name: production
      url: http://f1-app-load-balancer-44969073.eu-west-3.elb.amazonaws.com

    steps:
    - uses: actions/checkout@v3

    - name: Lowercase Image Name
      run: |
        echo "IMAGE_NAME=${IMAGE_NAME,,}" >> $GITHUB_ENV

    - name: Copy Kubernetes files via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.MASTER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        proxy_host: ${{ secrets.BASTION_HOST }}
        proxy_username: ubuntu
        proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "kubernetes/*"
        target: "/home/ubuntu/k8s-deploy"

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        proxy_host: ${{ secrets.BASTION_HOST }}
        proxy_username: ubuntu
        proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
        host: ${{ secrets.MASTER_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          
          # Appliquer les configurations
          kubectl apply -f /home/ubuntu/k8s-deploy/kubernetes/
          
          # Mise √† jour conditionnelle
          if [ "${{ needs.check-changes.outputs.should_build }}" == "true" ]; then
             echo "üîÑ Updating Image to GHCR version..."
             kubectl set image deployment/f1-app f1-app=${{ env.IMAGE_NAME }}:${{ github.sha }} -n f1-vote
             kubectl rollout status deployment/f1-app -n f1-vote
          else
             echo "‚è© No Build. Skipping image update."
          fi
          
          rm -rf /home/ubuntu/k8s-deploy